# Splashtop Streamer â€“ Safe Remediation Script
# - Only remediates broken installs
# - Health = Streamer service exists + running + binary exists
# - Forces 64-bit msiexec (Sysnative-safe)
# - Logs to ProgramData

$ErrorActionPreference = 'Stop'

# ==== CONFIG ====
$DownloadUrl = "https://www.dropbox.com/scl/fi/youolaff4q0rk6f1ow5oc/Splashtop_Streamer_Windows_DEPLOY_INSTALLER_v3.8.0.4_AXR25ZRHJ7Y4.msi?dl=1"

$BaseDir = "C:\ProgramData\Supreme\Installers\Splashtop"
$MsiPath = Join-Path $BaseDir "streamer.msi"
$LogDir  = Join-Path $BaseDir "Logs"
$RunLog  = Join-Path $LogDir  "run.log"
$MsiLog  = Join-Path $LogDir  "msi_install.log"
$UnLog   = Join-Path $LogDir  "msi_uninstall.log"

New-Item -Path $LogDir -ItemType Directory -Force | Out-Null

# ==== LOGGING ====
function Log($msg) {
    "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')  $msg" |
        Out-File -FilePath $RunLog -Append -Encoding utf8
}

# ==== FORCE 64-BIT MSIEXEC ====
function Get-MsiExec64 {
    if (-not [Environment]::Is64BitProcess -and [Environment]::Is64BitOperatingSystem) {
        return "$env:WINDIR\Sysnative\msiexec.exe"
    }
    return "$env:WINDIR\System32\msiexec.exe"
}

# ==== FIND STREAMER SERVICE ====
function Get-StreamerService {
    Get-Service -ErrorAction SilentlyContinue |
        Where-Object {
            $_.Name -match 'splashtop|srservice' -or
            $_.DisplayName -match 'splashtop|streamer'
        } |
        Select-Object -First 1
}

# ==== HEALTH CHECK ====
function Test-StreamerHealthy {
    $svc = Get-StreamerService
    if (-not $svc) {
        Log "Health: Streamer service not found."
        return $false
    }

    Log "Health: Found service $($svc.Name) ($($svc.Status))"

    if ($svc.Status -ne 'Running') {
        try {
            Start-Service -Name $svc.Name -ErrorAction Stop
            Start-Sleep 3
            $svc.Refresh()
        } catch {
            Log "Health: Service failed to start."
            return $false
        }
    }

    if ($svc.Status -ne 'Running') {
        Log "Health: Service not running after start."
        return $false
    }

    # Verify service binary exists
    try {
        $img = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\$($svc.Name)" -Name ImagePath).ImagePath
        $exe = ($img -replace '^"|"$','').Split(' ')[0]
        if (-not (Test-Path $exe)) {
            Log "Health: Service EXE missing: $exe"
            return $false
        }
    } catch {
        Log "Health: Unable to read service ImagePath."
        return $false
    }

    Log "Health: Streamer healthy."
    return $true
}

# ==== FIND SPLASHTOP PRODUCT CODES ====
function Get-SplashtopProductCodes {
    $paths = @(
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    $codes = @()

    foreach ($p in $paths) {
        Get-ItemProperty $p -ErrorAction SilentlyContinue |
            Where-Object { $_.DisplayName -match 'Splashtop.*Streamer' } |
            ForEach-Object {
                if ($_.PSChildName -match '^\{[A-F0-9\-]{36}\}$') {
                    $codes += $_.PSChildName
                }
                elseif ($_.UninstallString -match '\{[A-F0-9\-]{36}\}') {
                    $codes += $Matches[0]
                }
            }
    }

    $codes | Sort-Object -Unique
}

# ==== MAIN ====
try {
    Log "Starting. User=$env:USERNAME"

    if (Test-StreamerHealthy) {
        Log "No action needed. Exiting."
        exit 0
    }

    Log "Streamer unhealthy. Remediation required."

    $msiexec = Get-MsiExec64
    Log "Using msiexec: $msiexec"

    # Uninstall broken installs
    $codes = Get-SplashtopProductCodes
    foreach ($code in $codes) {
        Log "Uninstalling $code"
        Start-Process -FilePath $msiexec `
            -ArgumentList "/x $code /qn /norestart /l*v `"$UnLog`"" `
            -Wait
    }

    # Download MSI
    New-Item -Path $BaseDir -ItemType Directory -Force | Out-Null
    Log "Downloading MSI"
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Invoke-WebRequest -Uri $DownloadUrl -OutFile $MsiPath -UseBasicParsing

    # Install
    Log "Installing Streamer"
    Start-Process -FilePath $msiexec `
        -ArgumentList "/i `"$MsiPath`" /qn /norestart /l*v `"$MsiLog`"" `
        -Wait

    Log "Install completed."
    exit 0
}
catch {
    Log "ERROR: $($_.Exception.Message)"
    exit 1
}
